// schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ============================================
// SUPER ADMIN & MULTI-TENANCY MODELS
// ============================================

model Hospital {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  tenantId          String   @unique @default(uuid())
  name              String
  address           String
  city              String?
  state             String?
  country           String?
  pincode           String?
  email             String   @unique
  phone             String
  licenseNumber     String   @unique
  domain            String   @unique
  
  status            HospitalStatus @default(PENDING)
  isEmailVerified   Boolean  @default(false)
  verificationToken String?
  verificationTokenExpiry DateTime?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  activatedAt       DateTime?
  suspendedAt       DateTime?
  
  users             User[]
  patients          Patient[]
  departments       Department[]
  roles             Role[]
  prescriptions     Prescription[]
  
  @@map("hospitals")
}

enum HospitalStatus {
  PENDING
  VERIFIED
  ACTIVE
  SUSPENDED
  INACTIVE
}

// ============================================
// USER & AUTHENTICATION MODELS
// ============================================

model User {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  tenantId          String?
  hospitalId        String?  @db.ObjectId
  hospital          Hospital? @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  
  firstName         String
  lastName          String
  email             String   @unique
  phone             String
  username          String   @unique
  password          String
  
  department        String?
  specialization    String?
  shift             String?
  
  status            UserStatus @default(ACTIVE)
  isEmailVerified   Boolean  @default(false)
  mustChangePassword Boolean @default(true)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  lastLoginAt       DateTime?
  
  roleIds           String[] @db.ObjectId
  roles             Role[] @relation(fields: [roleIds], references: [id])
  passwordHistory   PasswordHistory[]
  passwordResets    PasswordReset[]
  refreshTokens     RefreshToken[]
  createdPatients   Patient[] @relation("CreatedBy")
  prescriptions     Prescription[]
  vitalsRecorded    Vital[]
  careNotes         CareNote[]
  
  @@map("users")
}

enum UserStatus {
  ACTIVE
  INACTIVE
  LOCKED
  PASSWORD_EXPIRED
}

model Role {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  tenantId    String?
  hospitalId  String?  @db.ObjectId
  hospital    Hospital? @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  
  name        String
  description String?
  isSystemRole Boolean @default(false)
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  userIds     String[] @db.ObjectId
  users       User[] @relation(fields: [userIds], references: [id])
  permissionIds String[] @db.ObjectId
  permissions Permission[] @relation(fields: [permissionIds], references: [id])
  
  @@unique([name])
  @@map("roles")
}

model Permission {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  resource    String
  action      String
  code        String   @unique
  description String?
  
  createdAt   DateTime @default(now())
  
  roleIds     String[] @db.ObjectId
  roles       Role[] @relation(fields: [roleIds], references: [id])
  
  @@unique([resource, action])
  @@map("permissions")
}

// ============================================
// PASSWORD & TOKEN MANAGEMENT
// ============================================

model PasswordHistory {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  passwordHash  String
  createdAt     DateTime @default(now())
  
  @@map("password_history")
}

model PasswordReset {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  token         String   @unique
  expiresAt     DateTime
  isUsed        Boolean  @default(false)
  usedAt        DateTime?
  
  createdAt     DateTime @default(now())
  
  @@map("password_resets")
}

model RefreshToken {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  token         String   @unique
  expiresAt     DateTime
  isRevoked     Boolean  @default(false)
  revokedAt     DateTime?
  
  createdAt     DateTime @default(now())
  
  @@map("refresh_tokens")
}

// ============================================
// HOSPITAL STRUCTURE
// ============================================

model Department {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  tenantId    String
  hospitalId  String   @db.ObjectId
  hospital    Hospital @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  
  name        String
  code        String
  description String?
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  patients    Patient[]
  
  @@unique([tenantId, code])
  @@map("departments")
}

// ============================================
// PATIENT MANAGEMENT
// ============================================

model Patient {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  tenantId          String
  hospitalId        String   @db.ObjectId
  hospital          Hospital @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  
  patientId         String   @unique
  
  firstName         String
  lastName          String
  dateOfBirth       DateTime
  gender            Gender
  bloodGroup        String?
  
  email             String?
  phone             String
  address           String
  city              String?
  state             String?
  pincode           String?
  
  emergencyContactName  String
  emergencyContactPhone String
  emergencyContactRelation String?
  
  photoUrl          String?
  
  patientType       PatientType
  departmentId      String?  @db.ObjectId
  department        Department? @relation(fields: [departmentId], references: [id])
  
  confidentialityLevel String @default("NORMAL")
  
  isActive          Boolean  @default(true)
  
  createdById       String   @db.ObjectId
  createdBy         User     @relation("CreatedBy", fields: [createdById], references: [id])
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  prescriptions     Prescription[]
  vitals            Vital[]
  careNotes         CareNote[]
  
  @@map("patients")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum PatientType {
  OPD
  IPD
}

// ============================================
// VITALS & CARE NOTES
// ============================================

model Vital {
  id                      String   @id @default(auto()) @map("_id") @db.ObjectId
  tenantId                String
  patientId               String   @db.ObjectId
  patient                 Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  bloodPressureSystolic   Float?
  bloodPressureDiastolic  Float?
  temperature             Float?
  pulse                   Int?
  spO2                    Float?
  weight                  Float?
  notes                   String?
  
  recordedById            String   @db.ObjectId
  recordedBy              User     @relation(fields: [recordedById], references: [id])
  recordedAt              DateTime @default(now())
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  
  @@map("vitals")
}

model CareNote {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  tenantId   String
  patientId  String   @db.ObjectId
  patient    Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  nurseId    String   @db.ObjectId
  nurse      User     @relation(fields: [nurseId], references: [id])
  
  note       String
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  @@map("care_notes")
}

// ============================================
// PRESCRIPTION MANAGEMENT
// ============================================

model Prescription {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  tenantId        String
  hospitalId      String   @db.ObjectId
  hospital        Hospital @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  
  prescriptionId  String   @unique
  
  patientId       String   @db.ObjectId
  patient         Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  doctorId        String   @db.ObjectId
  doctor          User     @relation(fields: [doctorId], references: [id])
  
  diagnosis       String?
  notes           String?
  
  medicines       Medicine[]
  
  isDispensed     Boolean  @default(false)
  dispensedAt     DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("prescriptions")
}

type Medicine {
  medicineName    String
  dosage          String
  frequency       String
  duration        String
  instructions    String?
}

// ============================================
// PRESCRIPTION TEMPLATES
// ============================================

model PrescriptionTemplate {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  tenantId    String
  
  name        String
  diagnosis   String?
  medicines   TemplateMedicine[]
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("prescription_templates")
}

type TemplateMedicine {
  medicineName    String
  dosage          String
  frequency       String
  duration        String
  instructions    String?
}

// ============================================
// EMAIL OTP FOR VERIFICATION
// ============================================

model EmailOtp {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String
  code      String
  purpose   String
  expiresAt DateTime
  isUsed    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email])
  @@map("email_otps")
}
